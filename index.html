<!DOCTYPE html>
<html>
    <head>
        <link href="https://fonts.googleapis.com/css?family=Russo+One|Ubuntu" rel="stylesheet">
        <style>
            body
            {
                background:#000;
                margin:0 auto;
                font-family:"Open Sans";
            }
            .Band
            {
                position:relative;
            }
            .Center
            {
                position:relative;
                max-width:960px;
                margin:0 auto;
            }
            .Pad
            {
                padding:1rem;
            }
        </style>
        <style>
            .Band.Header
            {
                background:#f00;
            }
            h1
            {
                color:#fff;
                text-transform:uppercase;
                font-family:"Russo One";
            }
            .Band.Copy .Center
            {
                background:rgba(256, 256, 256, 0.8);
            }
            .Tiers
            {
                overflow:hidden;
            }
            .Tier
            {
                display:block;
                float:left;
                margin:10px;
                background:#eee;
            }
            .Tier h3
            {
                color:#F00;
                font-family:"Russo One";
                text-transform:uppercase;
            }
            .Tier ul
            {
                padding-left:1em;
            }
            .Message
            {
                font-weight:bold;
            }
        </style>
    </head>
    <body>
        <img style="position:fixed; bottom:0; left:0; width:100%; height:auto;" src="background.jpg"/>
        <div class="Band Header">
            <div class="Center">
                <div class="Pad">
                    <h1>Bracketeer</h1>
                </div>
            </div>
        </div>
        <div class="Band Copy">
            <div class="Center">
                <div class="Pad">
                    <p>
                        Bet on the people betting on the players! What fun.
                    </p>
                    <p>
                        For each tier, bet on which TFL member(s) will place in the top three in the office bracket for that round. Highest score at the end wins.
                    </p>
                    <p>
                        Enter three names for each round. For every name that was in the <em>top three</em> that round, you will be awarded a point.
                        The <em>top three</em> for a round is: everyone tied for first, second, and third place in the office ESPN Tournament Challenge.
                    </p>
                    <p>
                        After you fill the form out, a link to email seth your results will show up. If more than three people sign up, the winner gets a starbucks gift card bragging rights. Tied winners can divide the coffee. But the cred? Ah, that's all yours for <em>life</em>.
                    </p>
                    <hr>
                    <div id="App"></div>
                </div>
            </div>
        </div>
        <script type="module">
            import { html, render } from 'https://unpkg.com/lit-html/lit-html.js';
            
            var Model;
            var Methods;
            var Render;

            Methods = {
                CheckDone:()=>
                {
                    var i;
                    for(i=0; i<Model.Tiers.length; i++)
                    {
                        if(!Model.Tiers[i].Filled)
                        {
                            Model.Completed = false;
                            return;
                        }
                    }
                    Model.Completed = true;
                    Model.Code = Methods.GenerateCode();
                },
                Reset:(inTier)=>
                {
                    inTier.Open = Model.People.slice();
                    inTier.Closed = [];
                    Render.Update(Model, Methods);
                },
                Add:(inTier, inIndex)=>
                {
                    inTier.Closed.push(inTier.Open.splice(inIndex, 1));
                    if(inTier.Closed.length >= 3)
                    {
                        inTier.Filled = true;
                        Methods.CheckDone();
                    }
                    Render.Update(Model, Methods);
                },
                Remove:(inTier, inIndex)=>
                {
                    var i;
                    var name;

                    name = inTier.Closed.splice(inIndex, 1);
                    for(i=0; i<inTier.Open.length; i++)
                    {
                        if(name < inTier.Open[i])
                        {
                            inTier.Open.splice(i, 0, name);
                            break;
                        }
                    }
                    inTier.Filled = false;
                    Model.Completed = false;
                    Render.Update(Model, Methods);
                },
                GenerateCode:()=>
                {
                    var i;
                    var tier;
                    var output;

                    output = [];
                    for(i=0; i<Model.Tiers.length; i++)
                    {
                        tier = Model.Tiers[i];
                        output.push({
                            Round:tier.Name,
                            Names:tier.Closed
                        });
                    }
                    return btoa(JSON.stringify(output));
                }
            };

            Model = {
                People:[
                    "Adam", "Alistair", "Amy",
                    "Barbara", "Bob",
                    "Caleb", "Carolyn",
                    "Donna",
                    "Ed", "Emily",
                    "Jake", "Jeannie",
                    "Jennifer", "Jenny", "John", "Jon",
                    "Kallen", "Karol",
                    "Leah",
                    "Matt", "Mike", "Mike's children",
                    "Nancy",
                    "Rebekah",
                    "Sarah P", "Sarah S", "Stacey"
                ],
                Tiers:[
                    {Name:"R32",  Open:[], Closed:[], Filled:false},
                    {Name:"Sweet 16", Open:[], Closed:[], Filled:false},
                    {Name:"Elite 8",  Open:[], Closed:[], Filled:false},
                    {Name:"Final 4",  Open:[], Closed:[], Filled:false},
                    {Name:"NGC",  Open:[], Closed:[], Filled:false}
                ],
                Completed:false,
                Code:""
            };

            Render = {};
            Render.Update = (inModel, inMethods) =>
            {
                render( Render.Layout(inModel, inMethods), document.querySelector("#App"));
            };
            Render.Layout = (inModel, inMethods) =>
            {
                var message;
                var output;

                var email = "Hi Seth, \nNot that I have a gambling problem, but your idea to bet on betting really appeals to me. \nHere's that weird code your dumb site generated. Don't screw my bracket up: \n"+inModel.Code;
                var href = "mailto:strowbridge@truthforlife.org?subject=I <3 sports &body=" + encodeURIComponent(email);

                if(inModel.Completed)
                {
                    message = html`
                    <p class="Message After">
                        You actually did it! Good luck, we're all counting on you. <a href=${href}>Email Seth</a>
                    </p>`;
                }
                else
                {
                    message = html`<p class="Message Before">Please fill out three names for each round:</p>`;
                }
                return html`
                <div class="Tiers">
                    ${ message }
                    ${inModel.Tiers.map( (inItem)=>{
                        return Render.Tier(inItem, inMethods);
                    } )}
                </div>
                `;
            },
            Render.Tier = (inTier, inMethods) =>
            {
                var option;
                if(inTier.Filled)
                {
                    option = html`<p>Nice!</p>`;
                }
                else
                {
                    option = html`
                    <select @change=${ (inEvent)=>{ inMethods.Add(inTier, inEvent.target.selectedIndex-1); inEvent.target.selectedIndex=0;} }>
                        <option>- add a name -</option>
                    ${inTier.Open.map( (inItem, inIndex)=>{
                        return html`
                        <option>${inItem}</option>
                        `;
                    } )}
                    </select>
                    `;
                }
                return html`
                <div class="Tier">
                    <div class="Pad">
                        <h3>${inTier.Name}</h3>
                        <ul>
                        ${inTier.Closed.map( (inItem, inIndex)=>{
                            return html`
                            <li><span>${inItem}</span> <button @click=${ ()=>{inMethods.Remove(inTier, inIndex);} }>X</button></li>
                            `;
                        } )}
                        </ul>
                        ${ option }
                    </div>
                </div>
                `;
            };

            var i;
            for(i=0; i<Model.Tiers.length; i++)
            {
                Methods.Reset(Model.Tiers[i]);
            }
            console.log(Model);
        </script>
    </body>
</html>